<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#2c3e50">
    
    <title>Reto Agente PE: Universal</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Press+Start+2P&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@500;700&display=swap" rel="stylesheet">

    <style>
        :root {
            --track-red: #c0392b;
            --time-green: #2ecc71;
            --time-yellow: #f1c40f;
            --time-red: #e74c3c;
            --gold: #FFD700;
            --silver: #C0C0C0;
            --bronze: #CD7F32;
        }
        
        * {
            user-select: none;
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }

        body { 
            font-family: 'Press Start 2P', cursive; 
            background-color: #2c3e50; 
            color: white; 
            overflow: hidden; 
            background-image: linear-gradient(rgba(0,0,0,0.3) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.3) 1px, transparent 1px);
            background-size: 20px 20px;
            height: 100vh; width: 100vw; margin: 0;
        }

        .readable-font { font-family: 'Roboto Mono', monospace; }

        .pixel-box { background: #fff; border: 4px solid #000; box-shadow: 6px 6px 0px rgba(0,0,0,0.5); color: #000; }
        .pixel-btn { border: 4px solid #000; box-shadow: 4px 4px 0px #000; transition: all 0.1s; cursor: pointer; color: white; text-transform: uppercase; }
        .pixel-btn:active { transform: translate(2px, 2px); box-shadow: 0px 0px 0px #000; }
        
        .btn-red { background-color: #e74c3c; } 
        .btn-blue { background-color: #3498db; }
        .btn-yellow { background-color: #f1c40f; color: #000; } 
        .btn-green { background-color: #2ecc71; }

        .track-bg {
            background: var(--track-red);
            border-top: 6px solid white; border-bottom: 6px solid white;
            position: relative;
        }

        /* Barras de Tiempo */
        #timer-container, .player-timer-container { width: 100%; height: 20px; background: #000; border: 2px solid #fff; overflow: hidden; position: relative; }
        #timer-bar-fill, #player-timer-fill { height: 100%; width: 100%; transition: width 1s linear, background-color 0.3s; background-color: var(--time-green); }
        
        .timer-high { background-color: var(--time-green) !important; }
        .timer-med { background-color: var(--time-yellow) !important; }
        .timer-low { background-color: var(--time-red) !important; animation: blink 0.5s infinite; }
        
        @keyframes blink { 50% { opacity: 0.7; } }

        .big-code { 
            font-size: 3rem; 
            letter-spacing: 0.2rem; 
            color: #f1c40f; 
            text-shadow: 4px 4px 0px #000; 
            word-break: break-all;
        }
        @media (min-width: 768px) { .big-code { font-size: 5rem; letter-spacing: 0.5rem; } }

        .host-option-text { font-size: 0.8rem; line-height: 1.3; font-weight: bold; }
        @media (min-width: 768px) { .host-option-text { font-size: 1.2rem; } }

        .diff-tag { font-size: 9px; padding: 6px 10px; border: 2px solid black; color: white; margin-bottom: 8px; display: inline-block; }
        
        .crt-overlay { 
            background: linear-gradient(rgba(18, 16, 16, 0) 50%, rgba(0, 0, 0, 0.05) 50%), linear-gradient(90deg, rgba(255, 0, 0, 0.02), rgba(0, 255, 0, 0.01), rgba(0, 0, 255, 0.02)); 
            background-size: 100% 2px, 3px 100%; 
            pointer-events: none; position: fixed; inset: 0; z-index: 600; 
        }

        .player-badge { 
            background: #fff; color: #000; padding: 6px 12px; 
            border: 2px solid #000; font-size: 10px; margin: 4px; 
            display: inline-block; 
            box-shadow: 2px 2px 0px #000;
        }
        
        .back-btn {
            position: absolute; top: 10px; left: 10px;
            background: #e74c3c; padding: 8px 12px;
            font-size: 8px; border: 2px solid #000;
            cursor: pointer; z-index: 50; color: white;
            box-shadow: 2px 2px 0px #000;
        }
        .back-btn:active { transform: translate(1px, 1px); box-shadow: none; }

        /* PODIO */
        .podium-bar {
            width: 60px; 
            border: 3px solid #000;
            display: flex; flex-direction: column; justify-content: flex-end; align-items: center;
            position: relative;
            transform-origin: bottom;
            animation: growUp 1s ease-out forwards;
        }
        @media (min-width: 768px) { .podium-bar { width: 100px; border: 4px solid #000; } }

        @keyframes growUp { from { transform: scaleY(0); } to { transform: scaleY(1); } }
        
        .podium-gold { background: var(--gold); height: 180px; z-index: 10; order: 2; box-shadow: 0 0 20px rgba(255, 215, 0, 0.5); }
        .podium-silver { background: var(--silver); height: 130px; z-index: 5; order: 1; }
        .podium-bronze { background: var(--bronze); height: 90px; z-index: 5; order: 3; }

        .winner-name { 
            position: absolute; top: -50px; 
            width: 150px; text-align: center; 
            font-size: 8px; color: #fff; text-shadow: 2px 2px 0 #000; 
            left: 50%; transform: translateX(-50%);
            background: rgba(0,0,0,0.7); padding: 4px; border-radius: 4px;
        }
        
        .confetti {
            position: fixed; width: 10px; height: 10px;
            background-color: #f0f;
            animation: fall linear forwards;
            z-index: 500;
        }
        @keyframes fall { to { transform: translateY(100vh) rotate(720deg); } }

        .honor-list-item {
            background: rgba(255,255,255,0.1);
            border-bottom: 1px solid rgba(255,255,255,0.2);
            padding: 8px;
            display: flex; justify-content: space-between;
            font-size: 10px;
            font-family: 'Roboto Mono', monospace;
        }
    </style>
</head>
<body class="flex flex-col items-center justify-center min-h-screen">
    <div class="crt-overlay"></div>

    <div id="status-screen" class="w-full max-w-sm pixel-box p-8 text-center z-10">
        <div id="loader" class="flex flex-col items-center gap-6">
            <div class="animate-spin rounded-full h-10 w-10 border-b-2 border-black"></div>
            <p class="text-[8px]">INICIANDO SISTEMA...</p>
            <p id="config-warning" class="text-[6px] text-red-500 hidden">CONFIGURACI√ìN PENDIENTE</p>
        </div>
    </div>

    <div id="role-screen" class="hidden w-full max-w-sm pixel-box p-8 text-center z-10 relative">
        <h1 class="text-[12px] md:text-[14px] mb-8 text-blue-900 uppercase leading-relaxed">RETO: EVALUACI√ìN NACIONAL</h1>
        <button onclick="window.showInstructions('host')" class="w-full py-4 mb-4 bg-blue-600 text-[10px] md:text-[12px] pixel-btn">COACH (DOCENTE)</button>
        <button onclick="window.showInstructions('player')" class="w-full py-4 bg-green-600 text-[10px] md:text-[12px] pixel-btn">ATLETA (ALUMNO)</button>
        <div class="mt-6">
            <button onclick="window.toggleMusic()" id="music-btn" class="text-[8px] text-gray-400 underline uppercase pixel-btn bg-gray-800 p-2 border-2 border-white hover:bg-gray-700">üéµ ACTIVAR M√öSICA</button>
        </div>
    </div>

    <div id="instruction-screen" class="hidden w-full max-w-md pixel-box p-8 z-10 relative">
        <button onclick="window.goBack()" class="back-btn">‚¨Ö SALIR</button>
        <h2 class="text-center text-[12px] mb-4 text-red-600 uppercase mt-6">REGLAS DEL JUEGO</h2>
        <div id="instruction-content" class="text-[9px] leading-relaxed space-y-4 mb-8 text-gray-700"></div>
        <button onclick="window.proceedAfterInstructions()" class="w-full py-4 bg-black text-white text-[10px] pixel-btn">ENTENDIDO</button>
    </div>

    <div id="player-lobby" class="hidden w-full max-w-sm pixel-box p-6 text-center z-10 relative">
        <button onclick="window.goBack()" class="back-btn">‚¨Ö SALIR</button>
        <h2 class="text-[10px] mb-2 text-blue-700 mt-8">C√ìDIGO DE SALA</h2>
        <input type="text" id="join-code" maxlength="6" class="w-full p-3 mb-4 border-4 border-black text-center text-lg uppercase outline-none" placeholder="C√ìDIGO">
        <h2 class="text-[10px] mb-2 text-blue-700">TU NICKNAME</h2>
        <input type="text" id="player-name" maxlength="10" class="w-full p-3 mb-6 border-4 border-black text-center text-base uppercase outline-none" placeholder="NOMBRE">
        <div id="join-error" class="text-red-600 text-[7px] mb-4 hidden">SALA NO ENCONTRADA</div>
        <button onclick="window.joinGame()" id="join-btn" class="w-full py-4 bg-orange-500 text-white text-[10px] pixel-btn">UNIRSE</button>
    </div>

    <div id="wait-screen" class="hidden w-full max-w-sm pixel-box p-10 text-center z-10">
        <div class="flex flex-col items-center gap-6">
            <i class="fas fa-running animate-bounce text-4xl text-green-600"></i>
            <p id="wait-message" class="text-[10px] leading-loose text-center">ESPERANDO INICIO...</p>
            
            <div id="final-rank-display" class="hidden w-full bg-blue-800 text-white p-4 border-4 border-yellow-400 animate-pulse">
                <p class="text-[10px] mb-2">TU POSICI√ìN FINAL:</p>
                <p id="rank-number" class="text-3xl font-bold text-yellow-400">#--</p>
            </div>

            <div class="mt-4 bg-black text-yellow-400 p-2 text-[8px] w-full text-center border-2 border-white">
                PUNTAJE: <span id="player-score-wait" class="text-white text-lg block mt-2">0</span>
            </div>

            <button id="player-exit-btn" onclick="window.goBack()" class="hidden w-full py-3 bg-red-600 text-white text-[8px] pixel-btn mt-4">VOLVER AL MEN√ö</button>
        </div>
    </div>

    <div id="host-lobby-screen" class="hidden w-full max-w-5xl z-10 text-center flex flex-col items-center relative p-4">
        <button onclick="window.goBack()" class="back-btn top-4 left-4 text-xs md:text-sm md:px-4 md:py-2">‚¨Ö CERRAR SALA</button>
        <h2 class="text-[10px] md:text-[14px] mb-4 text-white uppercase tracking-widest mt-8">C√ìDIGO DE ACCESO:</h2>
        <div class="pixel-box p-6 md:p-8 bg-black border-white mb-6">
            <h1 id="big-room-code" class="big-code">------</h1>
        </div>
        <div class="w-full max-w-3xl pixel-box p-4 md:p-6 bg-gray-100 min-h-[150px] mb-6">
            <p class="text-[10px] md:text-[12px] mb-4 text-gray-500 uppercase text-left font-bold">ATLETAS CONECTADOS (<span id="player-count">0</span>):</p>
            <div id="player-list-lobby" class="flex flex-wrap justify-center gap-2 max-h-[200px] overflow-y-auto"></div>
        </div>
        <button onclick="window.nextQuestion()" class="px-8 py-4 md:px-10 md:py-5 bg-green-500 text-white text-[10px] md:text-[12px] pixel-btn">¬°INICIAR EVALUACI√ìN!</button>
    </div>

    <div id="host-screen" class="hidden w-full max-w-6xl z-10 flex flex-col items-center p-2">
        <div class="w-full flex justify-between items-center mb-4 px-2 md:px-8">
            <div class="flex gap-2 md:gap-4">
                <div class="pixel-box px-3 py-1 bg-black border-white text-white text-[8px] md:text-[10px]">
                    <span class="hidden md:inline">PREGUNTA:</span> <span id="q-counter" class="text-yellow-400">1/--</span>
                </div>
                <div class="pixel-box px-3 py-1 bg-black border-white text-white text-[8px] md:text-[10px]">
                    <span class="hidden md:inline">SALA:</span> <span id="game-room-code" class="text-yellow-400">---</span>
                </div>
            </div>
            <div id="host-timer-text" class="bg-white px-3 py-1 border-2 md:border-4 border-black text-red-600 font-bold text-lg md:text-2xl min-w-[3rem] text-center">0s</div>
        </div>

        <div id="timer-container" class="mb-4 md:mb-8 w-full max-w-5xl mx-auto h-6 md:h-10 lg:h-12 border-4">
            <div id="timer-bar-fill"></div>
        </div>

        <div class="pixel-box w-full max-w-5xl p-4 md:p-8 mb-4 md:mb-6 text-center track-bg mx-auto shadow-2xl">
            <div id="diff-indicator" class="text-[8px] md:text-[10px] bg-black text-white px-3 py-1 mb-2 inline-block">TIEMPO: ---</div>
            <h2 id="host-question" class="text-xs sm:text-sm md:text-xl lg:text-2xl text-white uppercase leading-snug mt-2 drop-shadow-md font-bold">CARGANDO PREGUNTA...</h2>
        </div>
        
        <div id="host-options" class="grid grid-cols-1 md:grid-cols-2 gap-3 md:gap-6 w-full max-w-5xl mx-auto"></div>
        
        <div class="mt-6 md:mt-8">
            <button onclick="window.showPodium()" class="px-6 py-3 md:px-8 md:py-4 bg-red-600 text-white text-[8px] md:text-[10px] pixel-btn">FINALIZAR JUEGO</button>
        </div>
    </div>

    <div id="player-screen" class="hidden fixed inset-0 p-4 flex flex-col z-10 bg-[#1a1a1a]">
        <div class="flex justify-between items-center mb-2">
            <div class="text-[8px] text-white">PREGUNTA: <span id="player-q-counter">1/--</span></div>
            <div class="bg-black border border-white px-3 py-1 text-yellow-400 text-[10px]">
                PTS: <span id="player-score-game">0</span>
            </div>
        </div>
        
        <div class="player-timer-container mb-4 h-4 border-white">
            <div id="player-timer-fill"></div>
        </div>
        
        <div class="grid grid-cols-2 gap-4 flex-grow">
            <button onclick="window.sendAnswer(0)" class="btn-red pixel-btn flex flex-col items-center justify-center h-full transition-all duration-300"><i class="fas fa-square text-4xl md:text-5xl mb-2"></i></button>
            <button onclick="window.sendAnswer(1)" class="btn-blue pixel-btn flex flex-col items-center justify-center h-full transition-all duration-300"><i class="fas fa-caret-up text-5xl md:text-6xl mb-2"></i></button>
            <button onclick="window.sendAnswer(2)" class="btn-yellow pixel-btn flex flex-col items-center justify-center h-full transition-all duration-300"><i class="fas fa-circle text-4xl md:text-5xl mb-2"></i></button>
            <button onclick="window.sendAnswer(3)" class="btn-green pixel-btn flex flex-col items-center justify-center h-full transition-all duration-300"><i class="fas fa-play fa-rotate-270 text-4xl md:text-5xl mb-2"></i></button>
        </div>
    </div>

    <div id="podium-screen" class="hidden w-full max-w-5xl z-10 text-center flex flex-col items-center justify-center p-4">
        <h2 class="text-xl md:text-3xl text-yellow-400 mb-6 uppercase drop-shadow-md animate-bounce">üèÜ CAMPEONES üèÜ</h2>
        <div id="podium-container" class="flex items-end justify-center gap-2 md:gap-6 h-64 md:h-80 w-full mb-8"></div>
        <div class="w-full max-w-3xl bg-black bg-opacity-70 p-4 md:p-6 border-4 border-white rounded-lg mb-6">
            <h3 class="text-white text-[10px] md:text-[12px] mb-4 uppercase border-b-2 border-white pb-2">Cuadro de Honor</h3>
            <div id="honor-list" class="grid grid-cols-1 md:grid-cols-2 gap-4 text-left"></div>
        </div>
        <button onclick="window.resetGame()" class="px-8 py-4 md:px-12 md:py-6 bg-white text-black text-[10px] md:text-[12px] pixel-btn border-4 border-yellow-500 hover:bg-yellow-100">NUEVA PARTIDA</button>
    </div>

    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js';
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js';
        import { getFirestore, doc, setDoc, onSnapshot, updateDoc, collection, getDoc, increment, getDocs } from 'https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js';

        document.addEventListener('touchstart', (e) => { if (e.touches.length > 1) e.preventDefault(); }, { passive: false });
        
        // --- CONFIGURACI√ìN PARA GITHUB ---
        const manualConfig = {
            apiKey: "AIzaSyA6pQbm22ZOgf2DzX-LIl9rEFUs9Lcs_v8",
            authDomain: "agente-pe-48b82.firebaseapp.com",
            projectId: "agente-pe-48b82",
            storageBucket: "agente-pe-48b82.firebasestorage.app",
            messagingSenderId: "700138682010",
            appId: "1:700138682010:web:a2d2bf1d433e04ffd25123"
        };

        let firebaseConfig;
        let isInternalEnv = false;

        if (typeof __firebase_config !== 'undefined') {
            firebaseConfig = JSON.parse(__firebase_config);
            isInternalEnv = true;
        } else {
            firebaseConfig = manualConfig;
        }

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'agente-pe-universal-fix-v2';
        
        let app, auth, db, user;
        let myRole = '', myName = '', myScore = 0, currentCode = '';
        let currentCorrect = -1, currentStartTime = 0, currentLimit = 0, hasAnswered = false;
        let hostTimerInterval = null, playerTimerInterval = null;
        let questionQueue = [];
        let audioCtx = null, isMusicPlaying = false;
        let currentQuestionNum = 0, totalQuestions = 0;
        
        // --- NUEVAS FUNCIONES PARA ILUMINAR RESPUESTA ---
        window.highlightCorrectAnswerHost = (correctIdx) => {
            const container = document.getElementById('host-options');
            if(!container) return;
            const options = container.children;
            for(let i=0; i<options.length; i++) {
                if(i === correctIdx) {
                    options[i].classList.add('scale-105', 'ring-8', 'ring-white', 'animate-pulse', 'z-10');
                } else {
                    options[i].classList.add('opacity-25', 'grayscale');
                }
            }
        };

        window.highlightCorrectAnswerPlayer = (correctIdx) => {
            const playerScreen = document.getElementById('player-screen');
            const buttons = playerScreen.querySelectorAll('.grid > button');
            buttons.forEach((btn, i) => {
                if(i === correctIdx) {
                    btn.classList.add('scale-105', 'ring-8', 'ring-white', 'animate-pulse', 'z-10');
                    btn.classList.remove('opacity-25', 'grayscale');
                } else {
                    btn.classList.add('opacity-25', 'grayscale');
                    btn.classList.remove('scale-105', 'ring-8', 'ring-white', 'animate-pulse', 'z-10');
                }
            });
        };

        window.resetPlayerButtons = () => {
            const playerScreen = document.getElementById('player-screen');
            const buttons = playerScreen.querySelectorAll('.grid > button');
            buttons.forEach(btn => {
                btn.classList.remove('opacity-25', 'grayscale', 'scale-105', 'ring-8', 'ring-white', 'animate-pulse', 'z-10');
            });
        };
        // ------------------------------------------------

        // Funci√≥n UUID Compatible
        function generateUUID() {
            if (typeof crypto !== 'undefined' && crypto.randomUUID) return crypto.randomUUID();
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
        }
        const sessionID = generateUUID();

        // Audio
        function playTone(freq, dur, type = 'square') {
            if (!audioCtx || !isMusicPlaying) return;
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            gain.gain.setValueAtTime(0.05, audioCtx.currentTime);
            gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
            osc.connect(gain); gain.connect(audioCtx.destination);
            osc.start(); osc.stop(audioCtx.currentTime + dur);
        }

        let melodyInterval = null;
        function startBackgroundMusic() {
            if (melodyInterval) clearInterval(melodyInterval);
            let noteIdx = 0;
            const notes = [110, 0, 110, 0, 130, 0, 146, 0]; 
            melodyInterval = setInterval(() => {
                if(isMusicPlaying && notes[noteIdx] > 0) playTone(notes[noteIdx], 0.1, 'triangle');
                noteIdx = (noteIdx + 1) % notes.length;
            }, 250);
        }

        window.toggleMusic = () => {
            if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            if (audioCtx.state === 'suspended') audioCtx.resume();
            isMusicPlaying = !isMusicPlaying;
            const btn = document.getElementById('music-btn');
            if (isMusicPlaying) {
                btn.innerText = "üîä M√öSICA: ON"; btn.classList.add('bg-green-600'); btn.classList.remove('bg-gray-800');
                startBackgroundMusic(); playTone(440, 0.2); 
            } else {
                btn.innerText = "üîá M√öSICA: OFF"; btn.classList.add('bg-gray-800'); btn.classList.remove('bg-green-600');
                if (melodyInterval) clearInterval(melodyInterval);
            }
        };

        const fullDatabase = [
            { q: "¬øQU√â SIGNIFICA AEE?", c: "√ÅREAS ESTATALES DE EVALUACI√ìN", w: ["ADMINISTRACI√ìN ESTATAL DE EDUCACI√ìN", "ASOCIACI√ìN DE ESTUDIOS EDUCATIVOS", "AGENCIA ESTATAL DE EVALUACI√ìN"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â SIGNIFICA AEF?", c: "AUTORIDAD EDUCATIVA FEDERAL", w: ["ASOCIACI√ìN DE EDUCACI√ìN FEDERAL", "√ÅREA DE EVALUACI√ìN FEDERAL", "ADMINISTRACI√ìN DE ENSE√ëANZA FEDERAL"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â ES UN ATP?", c: "ASESOR T√âCNICO PEDAG√ìGICO", w: ["AUXILIAR T√âCNICO PROFESIONAL", "ADMINISTRADOR T√âCNICO PEDAG√ìGICO", "ASISTENTE T√âCNICO DE PLANEACI√ìN"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â SIGNIFICA CENEVAL?", c: "CENTRO NACIONAL DE EVALUACI√ìN PARA LA EDUCACI√ìN SUPERIOR", w: ["CENTRO NACIONAL DE VALIDACI√ìN DE ESTUDIOS SUPERIORES", "COMISI√ìN DE EVALUACI√ìN NACIONAL Y VALORACI√ìN", "CONSEJO EDUCATIVO DE EVALUACI√ìN Y LOGRO ACAD√âMICO"], t: 20, d: "F√ÅCIL" },
            { q: "¬øQU√â ES LA CPEUM?", c: "CONSTITUCI√ìN POL√çTICA DE LOS ESTADOS UNIDOS MEXICANOS", w: ["COMISI√ìN POL√çTICA DE EDUCACI√ìN DE LOS ESTADOS UNIDOS MEXICANOS", "CONSEJO PARA LA EDUCACI√ìN DE LA UNI√ìN MEXICANA", "CARTA DE POL√çTICAS EDUCATIVAS UNIVERSALES DE M√âXICO"], t: 12, d: "DIF√çCIL" },
            { q: "¬øQU√â SIGNIFICA DGE-SPEP?", c: "DIRECCI√ìN GENERAL DE EVALUACI√ìN", w: ["DIRECCI√ìN GENERAL DE EDUCACI√ìN SUPERIOR", "DEPARTAMENTO DE GESTI√ìN Y EVALUACI√ìN P√öBLICA", "DIRECCI√ìN DE GESTI√ìN EDUCATIVA Y POL√çTICAS"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â ES EL DOF?", c: "DIARIO OFICIAL DE LA FEDERACI√ìN", w: ["DEPARTAMENTO DE ORGANIZACI√ìN FEDERAL", "DOCUMENTO OFICIAL DE LA FEDERACI√ìN", "DIRECCI√ìN DE OFICINAS FEDERALES"], t: 15, d: "F√ÅCIL" },
            { q: "¬øQU√â FUE LA PRUEBA ENLACE?", c: "EVALUACI√ìN NACIONAL DEL LOGRO ACAD√âMICO EN CENTROS ESCOLARES", w: ["EXAMEN NACIONAL DE LOGROS ACAD√âMICOS Y CULTURALES ESCOLARES", "ESTUDIO NACIONAL DE LOGRO ESCOLAR Y APRENDIZAJE CENTRADO", "EVALUACI√ìN DE NIVEL ACAD√âMICO EN CENTROS EDUCATIVOS"], t: 15, d: "DIF√çCIL" },
            { q: "¬øQU√â ES EL EXANI-I?", c: "EXAMEN NACIONAL DE INGRESO A LA EDUCACI√ìN MEDIA SUPERIOR", w: ["EXAMEN DE ADMISI√ìN NACIONAL E INGRESO SUPERIOR", "EVALUACI√ìN DE INGRESO INICIAL A EDUCACI√ìN MEDIA", "EXAMEN DE APTITUD DE NIVEL INTERMEDIO SUPERIOR"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â SIGNIFICA EXCALE?", c: "EX√ÅMENES DE LA CALIDAD Y EL LOGRO EDUCATIVOS", w: ["EVALUACI√ìN POR CALIDAD EDUCATIVA Y LOGRO ESCOLAR", "EXAMEN DE CALIDAD LECTORA Y EDUCATIVA", "ESTUDIO DE CALIDAD Y LOGRO ESCOLAR AVANZADO"], t: 12, d: "DIF√çCIL" },
            { q: "¬øQU√â SIGNIFICA IEA?", c: "ASOCIACI√ìN INTERNACIONAL DE EVALUACI√ìN", w: ["INSTITUTO DE EVALUACI√ìN ACAD√âMICA INTERNACIONAL", "INSTITUCI√ìN DE ESTUDIOS AVANZADOS DE EVALUACI√ìN", "INVESTIGACI√ìN EDUCATIVA APLICADA INTERNACIONAL"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â SON LAS IES?", c: "INSTITUCIONES DE EDUCACI√ìN SUPERIOR", w: ["INSTITUTOS DE EDUCACI√ìN SECUNDARIA", "INICIATIVAS DE EDUCACI√ìN SUPERIOR", "INVESTIGACI√ìN Y ESTUDIOS SUPERIORES"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â ERA EL INEE?", c: "INSTITUTO NACIONAL PARA LA EVALUACI√ìN DE LA EDUCACI√ìN", w: ["INSTITUTO NACIONAL DE ESTUDIOS EDUCATIVOS Y EVALUACI√ìN", "INSTITUCI√ìN DE EVALUACI√ìN ESCOLAR Y ESTAD√çSTICA", "INICIATIVA NACIONAL DE EDUCACI√ìN Y EVALUACI√ìN"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â SIGNIFICA INEGI?", c: "INSTITUTO NACIONAL DE ESTAD√çSTICA Y GEOGRAF√çA", w: ["INSTITUTO NACIONAL DE ESTUDIOS GEOGR√ÅFICOS E INFORM√ÅTICOS", "INSTITUCI√ìN DE ESTAD√çSTICA GUBERNAMENTAL E INFORMACI√ìN", "INSTITUTO DE ECONOM√çA, GEOGRAF√çA E INFORM√ÅTICA"], t: 20, d: "F√ÅCIL" },
            { q: "¬øQU√â ES LA LGE?", c: "LEY GENERAL DE EDUCACI√ìN", w: ["LEY DE GESTI√ìN ESCOLAR", "LINEAMIENTOS GENERALES EDUCATIVOS", "LEGISLACI√ìN DE GOBIERNO EDUCATIVO"], t: 15, d: "F√ÅCIL" },
            { q: "¬øQU√â SIGNIFICA OCDE?", c: "ORGANIZACI√ìN PARA LA COOPERACI√ìN Y EL DESARROLLO ECON√ìMICOS", w: ["ORGANIZACI√ìN DE COMERCIO Y DESARROLLO ECON√ìMICO", "OFICINA DE COOPERACI√ìN EDUCATIVA Y DESARROLLO", "ORGANISMO DE CONTROL Y DESARROLLO ECON√ìMICO"], t: 20, d: "F√ÅCIL" },
            { q: "¬øQU√â ES EL SNTE?", c: "SINDICATO NACIONAL DE TRABAJADORES DE LA EDUCACI√ìN", w: ["SOCIEDAD NACIONAL DE TRABAJO ESCOLAR Y EDUCACI√ìN", "SINDICATO NACIONAL DE T√âCNICOS DE LA EDUCACI√ìN", "SISTEMA NACIONAL DE TRABAJADORES Y EDUCADORES"], t: 20, d: "F√ÅCIL" },
            { q: "¬øQU√â SIGNIFICA UNESCO?", c: "ORG. DE LAS NACIONES UNIDAS PARA LA EDUCACI√ìN, LA CIENCIA Y LA CULTURA", w: ["UNI√ìN DE NACIONES PARA LA EDUCACI√ìN SUPERIOR Y CULTURA", "UNIDAD DE ESTUDIOS CULTURALES, CIENT√çFICOS Y EDUCATIVOS", "ORGANIZACI√ìN UNIVERSAL DE CULTURA, CIENCIA Y EDUCACI√ìN"], t: 15, d: "DIF√çCIL" },
            { q: "¬øQU√â ES PISA?", c: "PROGRAMA PARA LA EVALUACI√ìN INTERNACIONAL DE LOS ALUMNOS", w: ["PROYECTO INTERNACIONAL DE SEGUIMIENTO AL ALUMNO", "PRUEBA INTERNACIONAL DE SABERES Y APRENDIZAJES", "PROGRAMA DE INVESTIGACI√ìN SOBRE ALUMNOS"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â ES LA SEP?", c: "SECRETAR√çA DE EDUCACI√ìN P√öBLICA", w: ["SISTEMA DE EDUCACI√ìN PRIMARIA", "SERVICIO DE EDUCACI√ìN P√öBLICA", "SOCIEDAD EDUCATIVA PROFESIONAL"], t: 20, d: "F√ÅCIL" },
            { q: "¬øQU√â ES EL SEN?", c: "SISTEMA EDUCATIVO NACIONAL", w: ["SERVICIO EDUCATIVO NACIONAL", "SECRETAR√çA DE EDUCACI√ìN NACIONAL", "SOCIEDAD DE ENSE√ëANZA NACIONAL"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â SIGNIFICA NEM?", c: "NUEVA ESCUELA MEXICANA", w: ["NORMA DE EDUCACI√ìN MEXICANA", "NUEVO ENFOQUE MAGISTERIAL", "N√öCLEO EDUCATIVO MODERNO"], t: 15, d: "MEDIO" },
            { q: "¬øQU√â SIGNIFICA NNA?", c: "NI√ëAS, NI√ëOS Y ADOLESCENTES", w: ["NUEVOS NI√ëOS Y ADOLESCENTES", "NORMA DE NI√ëEZ Y ADOLESCENCIA", "N√öCLEO DE NI√ëEZ Y APRENDIZAJE"], t: 15, d: "F√ÅCIL" },
            { q: "¬øQU√â ES EL PDA?", c: "PROCESO DE DESARROLLO DEL APRENDIZAJE", w: ["PROGRAMA DE DESARROLLO ACAD√âMICO", "PLAN DE APRENDIZAJE Y DESARROLLO", "PROYECTO DE DESEMPE√ëO ACAD√âMICO"], t: 15, d: "DIF√çCIL" },
            { q: "¬øQU√â ES LA USICAMM?", c: "UNIDAD DEL SISTEMA PARA LA CARRERA DE LAS MAESTRAS Y MAESTROS", w: ["UNIDAD DE SERVICIOS E INTELIGENCIA PARA LA CARRERA MAGISTERIAL", "UNI√ìN SINDICAL PARA LA CARRERA DE LAS MAESTRAS Y MAESTROS", "UNIDAD DE SUPERVISI√ìN E INGRESO A LA CARRERA MAGISTERIAL"], t: 12, d: "DIF√çCIL" }
        ];

        async function init() {
            try {
                if(manualConfig.apiKey === "PEGA_TU_API_KEY_AQUI" && !isInternalEnv) {
                    document.getElementById('config-warning').classList.remove('hidden');
                    return; 
                }

                app = initializeApp(firebaseConfig);
                auth = getAuth(app);
                db = getFirestore(app);

                if (isInternalEnv) {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else {
                        await signInAnonymously(auth);
                    }
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (u) => { if (u) { user = u; showScreen('role-screen'); } });
            } catch (err) { console.error("Init Error:", err); }
        }

        function showScreen(id) {
            document.querySelectorAll('body > div:not(.crt-overlay)').forEach(div => div.classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        window.goBack = () => { location.reload(); };
        function shuffle(array) { return array.sort(() => Math.random() - 0.5); }

        window.showInstructions = (role) => {
            myRole = role;
            const content = document.getElementById('instruction-content');
            content.innerHTML = role === 'host' ? `<p>‚Ä¢ COACH: Genera el c√≥digo.</p><p>‚Ä¢ Preguntas variadas y tiempo din√°mico.</p>` : `<p>‚Ä¢ ATLETA: Ingresa el c√≥digo.</p><p>‚Ä¢ ¬°Tu barra de tiempo cambia de color!</p>`;
            showScreen('instruction-screen');
        };

        window.proceedAfterInstructions = async () => {
            if (myRole === 'host') {
                currentCode = Array.from({length: 6}, () => 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789'[Math.floor(Math.random()*32)]).join('');
                document.getElementById('big-room-code').innerText = currentCode;
                // Game Code en pantalla de juego
                // Fix anterior: aseg√∫rate de que el elemento exista antes de asignarle texto
                const gc = document.getElementById('game-room-code');
                if(gc) gc.innerText = currentCode;

                questionQueue = shuffle([...fullDatabase]);
                totalQuestions = questionQueue.length;
                showScreen('host-lobby-screen');
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gamerooms', currentCode), { status: 'lobby', ts: Date.now(), players: {}, totalQ: totalQuestions });
                
                // ESCUCHAR JUGADORES (SUBCOLECCI√ìN)
                const playersCol = collection(db, 'artifacts', appId, 'public', 'data', 'gamerooms', currentCode, 'players');
                onSnapshot(playersCol, (snap) => {
                    const lobbyList = document.getElementById('player-list-lobby');
                    lobbyList.innerHTML = '';
                    document.getElementById('player-count').innerText = snap.size;
                    snap.forEach(d => { lobbyList.innerHTML += `<span class="player-badge uppercase">${d.data().name}</span>`; });
                    if(isMusicPlaying && snap.size > 0) playTone(523, 0.1, 'sine');
                });
            } else { showScreen('player-lobby'); }
        };

        window.nextQuestion = async () => {
            if (myRole !== 'host') return;
            if (questionQueue.length === 0) { window.showPodium(); return; }
            
            clearInterval(hostTimerInterval);
            showScreen('host-screen');
            playTone(660, 0.3, 'square'); 
            
            const item = questionQueue.shift();
            currentQuestionNum = totalQuestions - questionQueue.length;
            const options = shuffle([{ t: item.c, ok: true }, ...item.w.map(x => ({ t: x, ok: false }))]);
            currentCorrect = options.findIndex(o => o.ok);

            document.getElementById('q-counter').innerText = `${currentQuestionNum}/${totalQuestions}`;
            document.getElementById('host-question').innerText = item.q;
            document.getElementById('diff-indicator').innerText = `${item.t}s | ${item.d}`;
            // Re-asignar c√≥digo de sala por si acaso
            const gc = document.getElementById('game-room-code');
            if(gc) gc.innerText = currentCode;

            const container = document.getElementById('host-options');
            container.innerHTML = '';
            const colors = ['btn-red', 'btn-blue', 'btn-yellow', 'btn-green'];
            options.forEach((opt, i) => {
                container.innerHTML += `<div class="${colors[i]} pixel-box p-4 md:p-6 text-white border-black flex items-center justify-center text-center h-auto min-h-[5rem] cursor-default transition-all duration-300"><span class="readable-font text-xs sm:text-sm md:text-xl lg:text-2xl leading-tight break-words hyphens-auto">${opt.t}</span></div>`;
            });

            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gamerooms', currentCode), { 
                status: 'playing', correct: currentCorrect, ts: Date.now(), limit: item.t, qNum: currentQuestionNum, tQ: totalQuestions
            });

            startHostTimer(item.t);
        };

        function startHostTimer(sec) {
            let left = sec;
            const bar = document.getElementById('timer-bar-fill');
            const text = document.getElementById('host-timer-text');
            bar.style.transition = 'none'; bar.style.width = '100%'; bar.className = 'timer-high';
            void bar.offsetWidth; 
            bar.style.transition = `width ${sec}s linear`; bar.style.width = '0%';

            hostTimerInterval = setInterval(async () => {
                left--; text.innerText = Math.max(0, left) + 's';
                const ratio = left / sec;
                if (ratio <= 0.25) { bar.className = 'timer-low'; playTone(220, 0.1, 'sawtooth'); } 
                else if (ratio <= 0.5) bar.className = 'timer-med';

                if (left <= 0) {
                    clearInterval(hostTimerInterval);
                    // Mantenemos el estatus 'timeout' pero agregamos la l√≥gica visual de 5 segundos
                    await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gamerooms', currentCode), { status: 'timeout' });
                    document.getElementById('host-question').innerText = "¬°TIEMPO AGOTADO! RESPUESTA CORRECTA:";
                    
                    // LLAMADA A LA NUEVA FUNCI√ìN PARA ILUMINAR EN EL HOST
                    window.highlightCorrectAnswerHost(currentCorrect);
                    
                    playTone(110, 0.5, 'sawtooth');
                    // MODIFICADO: Esperar 5000ms en lugar de 2000ms
                    setTimeout(() => window.nextQuestion(), 5000); 
                }
            }, 1000);
        }

        // PLAYER LOGIC (FIXED)
        window.joinGame = async () => {
            const cin = document.getElementById('join-code').value.trim().toUpperCase();
            const name = document.getElementById('player-name').value.trim().toUpperCase();
            if (!cin || !name) return;
            const btn = document.getElementById('join-btn');
            btn.disabled = true; btn.innerText = "CONECTANDO...";
            
            // Usamos la colecci√≥n principal artifacts/appId/public/data/gamerooms
            const roomRef = doc(db, 'artifacts', appId, 'public', 'data', 'gamerooms', cin);
            
            try {
                const roomSnap = await getDoc(roomRef);
                if (!roomSnap.exists()) { 
                    document.getElementById('join-error').innerText = "SALA NO ENCONTRADA";
                    document.getElementById('join-error').classList.remove('hidden'); 
                    btn.disabled = false; btn.innerText = "VINCULAR"; return; 
                }
                
                currentCode = cin; myName = name;
                
                // USAR SUBCOLECCIONES (MEJOR PARA PERMISOS EST√ÅNDAR)
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gamerooms', currentCode, 'players', sessionID), { 
                    name: myName, score: 0 
                });

                // Escuchar estado del juego (Documento Padre)
                onSnapshot(roomRef, (snap) => {
                    if (!snap.exists()) return;
                    const s = snap.data();
                    
                    if (s.status === 'playing' && s.ts !== currentStartTime) {
                        currentStartTime = s.ts; currentCorrect = s.correct; currentLimit = s.limit;
                        hasAnswered = false; 
                        
                        // RESTABLECER BOTONES
                        window.resetPlayerButtons();
                        
                        showScreen('player-screen');
                        document.getElementById('player-q-counter').innerText = `${s.qNum}/${s.tQ}`;
                        startPlayerTimer(s.limit);
                        
                    } else if (s.status === 'timeout') {
                        // NUEVA L√ìGICA: Mostrar siempre la respuesta en el celular, hayan contestado o no.
                        hasAnswered = true; // Bloquea clics adicionales
                        showScreen('player-screen');
                        window.highlightCorrectAnswerPlayer(s.correct);
                        
                    } else if (s.status === 'finished') { 
                        // Obtener todos los jugadores para el ranking final (Correcci√≥n)
                        getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'gamerooms', currentCode, 'players')).then(sn => {
                            const allP = [];
                            sn.forEach(d => allP.push(d.data()));
                            showFinalRank(allP);
                        });
                    }
                });
                
                // Escuchar mi propio puntaje (Subcolecci√≥n)
                onSnapshot(doc(db, 'artifacts', appId, 'public', 'data', 'gamerooms', currentCode, 'players', sessionID), (snap) => {
                    if(snap.exists()) {
                        const sc = snap.data().score;
                        myScore = sc;
                        document.getElementById('player-score-game').innerText = sc;
                        document.getElementById('player-score-wait').innerText = sc;
                    }
                });

                showScreen('wait-screen');
            } catch (error) { 
                console.error("Join Error:", error);
                let msg = "ERROR DE CONEXI√ìN";
                if(error.code === 'permission-denied') msg = "PERMISO DENEGADO (Revisa Reglas)";
                document.getElementById('join-error').innerText = msg;
                document.getElementById('join-error').classList.remove('hidden');
                btn.disabled = false; btn.innerText = "REINTENTAR"; 
            }
        };

        function startPlayerTimer(sec) {
            if(playerTimerInterval) clearInterval(playerTimerInterval);
            const pBar = document.getElementById('player-timer-fill');
            pBar.style.transition = 'none'; pBar.style.width = '100%'; pBar.className = 'timer-high';
            void pBar.offsetWidth;
            pBar.style.transition = `width ${sec}s linear`; pBar.style.width = '0%';
            
            let pLeft = sec;
            playerTimerInterval = setInterval(() => {
                pLeft--;
                const pRatio = pLeft / sec;
                if (pRatio <= 0.25) pBar.className = 'timer-low';
                else if (pRatio <= 0.5) pBar.className = 'timer-med';
                if(pLeft <= 0) clearInterval(playerTimerInterval);
            }, 1000);
        }

        window.sendAnswer = async (idx) => {
            if (hasAnswered) return;
            hasAnswered = true;
            if (idx === currentCorrect) {
                const elapsed = (Date.now() - currentStartTime) / 1000;
                const bonus = Math.max(0, Math.floor((currentLimit - elapsed) * 20));
                const points = 100 + bonus;
                await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gamerooms', currentCode, 'players', sessionID), { 
                    score: increment(points) 
                });
                playTone(880, 0.1, 'triangle'); 
            } else { playTone(150, 0.3, 'sawtooth'); }
            showScreen('wait-screen');
            document.getElementById('wait-message').innerText = "RESPUESTA REGISTRADA";
        };

        function showFinalRank(playersData) {
            playersData.sort((a, b) => b.score - a.score);
            // B√∫squeda robusta por nombre (en caso de duplicados, toma el primero)
            // Idealmente se usar√≠a ID, pero playersData es un array de datos puros aqu√≠.
            const myRank = playersData.findIndex(p => p.name === myName) + 1;
            
            document.getElementById('wait-message').innerText = "¬°TORNEO FINALIZADO!";
            const rankDiv = document.getElementById('final-rank-display');
            rankDiv.classList.remove('hidden');
            document.getElementById('rank-number').innerText = `#${myRank}`;
            document.getElementById('player-exit-btn').classList.remove('hidden');
            showScreen('wait-screen');
        }

        window.showPodium = async () => {
            clearInterval(hostTimerInterval);
            if(melodyInterval) clearInterval(melodyInterval); 
            await updateDoc(doc(db, 'artifacts', appId, 'public', 'data', 'gamerooms', currentCode), { status: 'finished' });
            showScreen('podium-screen');
            
            for(let i=0; i<50; i++) {
                const conf = document.createElement('div');
                conf.className = 'confetti';
                conf.style.left = Math.random() * 100 + 'vw';
                conf.style.backgroundColor = `hsl(${Math.random()*360}, 100%, 50%)`;
                conf.style.animationDuration = Math.random() * 3 + 2 + 's';
                document.body.appendChild(conf);
            }

            const playersSnap = await getDocs(collection(db, 'artifacts', appId, 'public', 'data', 'gamerooms', currentCode, 'players'));
            const data = [];
            playersSnap.forEach(d => data.push(d.data()));
            data.sort((a, b) => b.score - a.score);
            
            // Top 3 Podium
            const container = document.getElementById('podium-container');
            container.innerHTML = '';
            const positions = [{ idx: 1, class: 'podium-silver' }, { idx: 0, class: 'podium-gold' }, { idx: 2, class: 'podium-bronze' }];
            positions.forEach(pos => {
                const p = data[pos.idx];
                if (p) {
                    container.innerHTML += `
                        <div class="podium-bar ${pos.class}">
                            <div class="winner-name">
                                <span class="block font-bold text-yellow-300 text-[8px] md:text-[10px]">${pos.idx === 0 ? 'üèÜ' : ''} ${p.name}</span>
                                <span class="block text-white text-[8px] md:text-[10px]">${p.score} PTS</span>
                            </div>
                            <span class="text-xl md:text-3xl text-black font-bold mb-2">${pos.idx + 1}</span>
                        </div>`;
                }
            });

            // Honor List (4-8)
            const honorList = document.getElementById('honor-list');
            honorList.innerHTML = '';
            for(let i=3; i<8; i++) {
                if(data[i]) {
                    honorList.innerHTML += `
                    <div class="honor-list-item">
                        <span class="text-white">${i+1}. ${data[i].name}</span>
                        <span class="text-yellow-400">${data[i].score}</span>
                    </div>`;
                }
            }
        };

        window.resetGame = () => location.reload();
        window.onload = init;
    </script>
</body>
</html>
